---
index: 1
---

# 渲染机制

`Preezid` 的渲染分为三层, `lts 编译` 阶段, `PiteRender渲染` 阶段, `浏览器渲染` 阶段.

## `lts 编译` 阶段

`lts 编译` 阶段负责将 `lts` 代码转换成 `PiteRender TS` 代码, 该阶段由 `Preezid Dev` 和 `Preezid Compiler` 共同完成.

该阶段会进行以下工作:

1. 自动注册:
    
    服务器启动时, `Preezid Dev` 将会将所有文件加载到内存中, 之后扫描所有文件, 自动注册组件和页面等资源到根文件中.
    
2. 自动导入:

    自动注册之后, `Preezid Dev` 会根据代码中的引用关系, 再各个文件中自动导入所需的组件和页面等资源.

3. 代码转换:

    注册导入结束后, `Preezid Compiler` 会将 `lts` 代码转换成 `PiteRender TS` 代码, 该过程包括将识别所有 `lts` 标签, 转换为 `PiteRender` 提供的 `render()` 类和链式调用语法.

## `PiteRender 渲染` 阶段

`PiteRender` 只是一个 `ts` 库, 它使用类和链式调用的方式描述 DOM, 并使用 `.build()` 方法生成最终的 DOM 结构.

`Preezid Compiler` 输出的就是 `ts` 代码, 只要导入 `PiteRender` 库, 就可以直接运行.

与 `react` 和 `vue` 虚拟节点类似, 只不过 `react` 和 `vue` 会在内存中维护一个特殊数据结构的 `obj`, 之后再通过渲染器渲染为真正的 DOM.

而 `Preezid Compiler` 输出的就是纯粹的 `ts` 代码, 可以直接运行为 DOM, 因此没有虚拟节点的概念, 也没有 `diff` 算法, 更新速度极快.

与 `svelte` 类似, `PiteRender` 库的 `.build()` 函数将构建 DOM 字符串和 `runtime.js` 文件, 该文件包含更新 DOM 的代码, 功能如下:

1. 识别静态代码, 直接构建 DOM 字符串

    对于如下的代码:

    ```ts
    render("span").slot("I 'm a static DOM.").build()
    ```
    
    `.build()` 会直接将其转换为字符串:

    ```html
    <span>I 'm a static DOM.</span>
    ```

2. 识别插值依赖代码, 维护 `runtime.js`

    对于如下的代码:

    ```ts
    render("span").slot("Label is: " + label).build()
    ```
    
    `.build()` 会直接将其转换为带标记的字符串:

    ```html
    <span data-id-{hash-id}>Label is</span>
    ```
   
    ```js
    const span = document.querySelector("[data-id-{hash-id}]")
    span.innerText = "Label is: " + label
    ```

3. 识别动态创建 DOM, 维护 `runtime.js`

    对于如下的代码:

    ```ts
    render("div")
      .slot(() => {
        arr.forEach(item => {
          return render("span").slot(item.name).build()
        })
      })
      .build()
    ```
    
    `.build()` 会直接将其转换为带标记的字符串:

    ```html
    <div data-id-{随机生成id}></div>
    ```

    ```js
    const div = document.querySelector("[data-id-{随机生成id}]")
    arr.forEach(item => {
      const span = document.createElement("span")
      span.innerText = item.name
      div.appendChild(span)
    })
    ```

该部分已经通过 `SSG` 方式构建了各个路由/页面的静态文件, 以及运行时的 `runtime.js` 文件.

对于动态路由文件, `Preezid Dev` 会在服务器端运行 `PiteRender` 代码, 构建出最终的 `HTML` 字符串和 `runtime.js` 文件, 并返回给浏览器.

## `浏览器渲染` 阶段

浏览器直接渲染静态 `HTML` 文件, 并加载 `runtime.js` 文件即可.
